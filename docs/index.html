<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!-- Contenedor para el header -->
  <div id="header-container"></div>
  <div id="bottom-container">
</div>

  <div class="consultor-container" id="consultor-container">
    <h2>Consulta de expedientes</h2>
    <form id="formConsulta">
        <div class="form-group">
            <div id="error"></div>
            <label for="numExpediente">Numero de expediente:</label>
            <input type="text" id="numExpediente" name="numExpediente" placeholder="Ingresa tu Mumero de Expediente" required>
        </div>
        <div class="form-group">
            <label for="dni">DNI:</label>
            <input type="text" id="dni" name="dni" placeholder="Ingresa tu DNI" required>
        </div>
        <div class="form-group">
          <label for="matricula">Matricula:</label>
          <input type="text" id="matricula" name="matricula" placeholder="Ingresa tu matricula" required>
      </div>
        <button type="submit">Consultar</button>
    </form>
    <p>¿Quieres acceder como usuario? <a href="./iniciasesion.html">Haz login aquí</a></p>
</div>

<div class="consultor-container" id="creador-container" >
  <h2>Consulta de expedientes</h2>
  <form id="formCrear">
      <div class="form-group">
          <div id="error"></div>
          <label for="descripcion">Descripción:</label>
          <input type="text" id="descripcion" name="descripcion" placeholder="Ingresa una Descripción" required>
      </div>
      <div class="form-group">
          <label for="dni_cliente">DNI cliente:</label>
          <input type="text" id="dni_cliente" name="dni_cliente" placeholder="Ingresa un DNI" required>
      </div>
      <div class="form-group">
        <label for="matricula">Matricula:</label>
        <input type="text" id="matricula" name="matricula" placeholder="Ingresa una matricula" required>
    </div>
    <div class="form-group">
      <label for="id_perito">ID Perito:</label>
      <input type="number" id="id_perito" name="id_perito" placeholder="Ingresa el ID del perito" required>
    </div>
      <button type="submit">Crear expediente</button>
      <button type="button" id="cancelarCrear">Cancelar</button>
  </form>
</div>



<div class="app-body">
    <!-- Barra lateral izquierda (con contenido rotado) -->
    <div class="sidebar-left">
        <div class="expedientes-container">
          <div class="expediente nuevo" id="crear-expediente">+ Crear nuevo expediente</div>
        </div>
      </div>
      
    <!-- Contenido principal -->
    <div class="main-content">
      <h1>Informacion sobre el expediente:</h1>
      <p id="info"></p>
      <p>Estado:</p>
      <div id="uno" class="bloques" hidden>
        <h1>Recepción de la declaración</h1>

  <div id="areaSubida">
    <form id="formArchivos">
      <label>Foto:</label>
      <input type="file" name="foto" accept="image/*" required><br>
      <label>PDF:</label>
      <input type="file" name="pdf" accept="application/pdf" required><br>
      <button type="submit">Subir</button>
    </form>
  </div>
  <div id="vistas" style="display:none;">
    <h3>Archivos cargados:</h3>
    <div><a id="linkFoto"  href="#" download>Descargar foto</a></div>
    <div><a id="linkPDF"   href="#" download>Descargar PDF</a></div>
  </div>
  <div id="botonesUno">
  <button id="rectificar">Reemplazar archivos</button>
  <button id="nextEstado">Siguiente paso</button>
  </div>
  <script>
    let USUARIO_ACTUAL = null; // Variable global para el usuario actual
    let gmailCompañia = null; // Variable para el email de contacto
    let cantidadAPagar = null; // Variable para la cantidad a pagar
    
  async function initPaso1(id) {
    
  const area    = document.getElementById('areaSubida');
  const vistas  = document.getElementById('vistas');
  const form    = document.getElementById('formArchivos');
  const linkF   = document.getElementById('linkFoto');
  const linkP   = document.getElementById('linkPDF');
  const btnNext = document.getElementById('nextEstado');
  const btnRec  = document.getElementById('rectificar');

  // Quitamos listeners previos para no duplicar
  form.replaceWith(form.cloneNode(true));
  btnNext.replaceWith(btnNext.cloneNode(true));
  btnRec.replaceWith(btnRec.cloneNode(true));
  // Re-obtener referencias limpias
  const cleanForm   = document.getElementById('formArchivos');
  const cleanBtnNext= document.getElementById('nextEstado');
  const cleanBtnRec = document.getElementById('rectificar');

  

  try {
    // 1) Comprueba si ya hay archivos
    const res = await fetch(`/archivos/${id}/archivos`);
    if (!res.ok) throw new Error(`GET archivos falló: ${res.status}`);
    const { foto_path, pdf_path } = await res.json();

    if (foto_path && pdf_path) {
      area.style.display   = 'none';
      vistas.style.display = 'block';
      linkF.href = `/descargas/${foto_path}`;
      linkP.href = `/descargas/${pdf_path}`;
    } else {
      area.style.display   = 'block';
      vistas.style.display = 'none';
      //Depende de user
      if(USUARIO_ACTUAL != 'sin'){
    area.style.display = 'none';
    cleanBtnRec.style.display = 'none';
  };
  if(USUARIO_ACTUAL == 'perito'){
    
    cleanBtnNext.style.display = 'none';
    area.style.display = 'none';
    cleanBtnRec.style.display = 'none';}
    if(USUARIO_ACTUAL != 'aseguradora'){

      cleanBtnNext.style.display = 'none';
    };
    }

    // 2) Subida de archivos
    cleanForm.addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const data = new FormData(cleanForm);
        const resp = await fetch(`/archivos/${id}/archivos`, {
          method: 'POST',
          body: data
        });
        if (!resp.ok) throw new Error(`POST archivos falló: ${resp.status}`);
        await initPaso1(id); // refresca la vista
        getEstado();
      } catch (err) {
        console.error('Error en subida de archivos:', err);
        alert('Error subiendo archivos, comprueba consola.');
      }
    });

    // 3) Rectificar
    cleanBtnRec.addEventListener('click', () => {
      vistas.style.display = 'none';
      area.style.display   = 'block';
    });

    // 4) Siguiente estado
    pasarStep(id, cleanBtnNext);

  } catch (err) {
    console.error('Error en initPaso1:', err);
    alert('No se pudieron cargar los archivos. Mira la consola.');
  }
}

</script>
      </div>
      <div id="dos" class="bloques" hidden>
        <h1>Expediente con comprobación</h1>
        <div id="areaSubida">
          <form id="formArchivosAclaracion">
            <label>PDF:</label>
            <input type="file" name="pdf" accept="application/pdf" required><br>
            <button type="submit">Subir</button>
          </form>
        </div>
          
        
        <div id="vistas" style="display:none;">
          <h3>Archivos cargados:</h3>
          <div><a id="linkPDF" href="#" download>Descargar PDF</a></div>
          
         
        </div>
        <div id="botonesDos">
        <button id="rectificar">Reemplazar archivos</button>
         <button id="btnNextAclar">Siguiente paso</button>
      </div>
        <script>
          async function initPaso2(id) {
            // 1) Seleccionamos solo el contenedor del paso 2
            const contenedor = document.getElementById('dos');
            if (!contenedor) return;
      
            // 2) Buscamos dentro de él los IDs tal cual aparecen en tu HTML
            const form    = contenedor.querySelector('#formArchivosAclaracion');
            const btnNext = contenedor.querySelector('#btnNextAclar');
            const btnRec  = contenedor.querySelector('#rectificar');
            const area    = contenedor.querySelector('#areaSubida');
            const vistas  = contenedor.querySelector('#vistas');
            const linkP   = contenedor.querySelector('#linkPDF');
      
            // Si alguno no se encuentra, salimos por seguridad
            if (!form || !btnNext || !btnRec || !area || !vistas || !linkP) {
              console.error('initPaso2: Falta alguno de los elementos dentro de #dos');
              return;
            }
      
            // 3) Clonamos para quitar listeners previos (evita duplicados)
            form.replaceWith(form.cloneNode(true));
            btnNext.replaceWith(btnNext.cloneNode(true));
            btnRec.replaceWith(btnRec.cloneNode(true));
      
            // 4) Recuperamos las referencias tras el clone
            const cleanForm    = contenedor.querySelector('#formArchivosAclaracion');
            const cleanBtnNext = contenedor.querySelector('#btnNextAclar');
            const cleanBtnRec  = contenedor.querySelector('#rectificar');
      
            try {
              // 5) Comprobamos si ya hay un PDF de aclaración en la BD
              const res = await fetch(`/archivos/${id}/archivos/aclaracion`);
              if (!res.ok) throw new Error(`GET aclaración falló: ${res.status}`);
              const { pdf_aclaracion } = await res.json();
      
              if (pdf_aclaracion) {
                area.style.display   = 'none';
                vistas.style.display = 'block';
                linkP.href = `/descargas/${pdf_aclaracion}`;
              } else {
                area.style.display   = 'block';
                vistas.style.display = 'none';

                  if(USUARIO_ACTUAL != 'aseguradora'){
                    area.style.display = 'none';
                    cleanBtnNext.style.display = 'none';
                    cleanBtnRec.style.display = 'none';
                  };
              }
      
              // 6) Listener para subir un nuevo PDF de aclaración
              cleanForm.addEventListener('submit', async e => {
                e.preventDefault();
                try {
                  const data = new FormData(cleanForm);
                  const resp = await fetch(`/archivos/${id}/archivos/aclaracion`, {
                    method: 'POST',
                    body: data
                  });
                  if (!resp.ok) throw new Error(`POST aclaración falló: ${resp.status}`);
                  // Después de subir, refrescamos esta misma sección
                  await initPaso2(id);
                  getEstado();
                } catch (err) {
                  console.error('Error en subida de aclaración:', err);
                  alert('Error subiendo PDF de aclaración. Revisa la consola.');
                }
              });
      
              // 7) “Rectificar”: volvemos a mostrar el formulario
              cleanBtnRec.addEventListener('click', () => {
                vistas.style.display = 'none';
                area.style.display   = 'block';
              });
      
              // 8) Botón para pasar de estado
              pasarStep(id, cleanBtnNext);
      
            } catch (err) {
              console.error('Error en initPaso2:', err);
              alert('No se pudieron cargar los archivos de aclaración. Mira la consola.');
            }
          }
        </script>
      </div>
      
      <div id="tres" class="bloques" hidden>
        <h1>Cobertura de Póliza</h1>
        <div id="areaSubidaCobertura">
          <form id="formArchivosCobertura">
            <label>PDF de Cobertura:</label><br>
            <input type="file" name="pdf" accept="application/pdf" required><br>
            <button type="submit">Subir cobertura</button>
          </form>
          
        </div>
        <div id="vistasCobertura" style="display:none;">
          <h3>PDF de Cobertura subido:</h3>
          <div><a id="linkPDFCobertura" href="#" download>Descargar cobertura</a></div>
          
        </div>
        <div id="botonesTres">
        <button id="rectificarCobertura">Reemplazar cobertura</button>
        <button id="btnNextCobertura">Siguiente paso</button>
      </div>
        <script>
          async function initPaso3(id) {
            // 1) Localiza solo el contenedor de “tres”
            const contenedor = document.getElementById('tres');
            if (!contenedor) return;
      
            // 2) Busca dentro de él los elementos con sus nuevos IDs
            const form    = contenedor.querySelector('#formArchivosCobertura');
            const btnNext = contenedor.querySelector('#btnNextCobertura');
            const btnRec  = contenedor.querySelector('#rectificarCobertura');
            const area    = contenedor.querySelector('#areaSubidaCobertura');
            const vistas  = contenedor.querySelector('#vistasCobertura');
            const linkP   = contenedor.querySelector('#linkPDFCobertura');
      
            // Comprueba que existan todas las referencias
            if (!form || !btnNext || !btnRec || !area || !vistas || !linkP) {
              console.error('initPaso3: algún ID falta dentro de #tres');
              return;
            }
      
            // 3) Remueve posibles listeners anteriores clonando nodos
            form.replaceWith(form.cloneNode(true));
            btnNext.replaceWith(btnNext.cloneNode(true));
            btnRec.replaceWith(btnRec.cloneNode(true));
      
            // 4) Vuelve a tomar las referencias “limpias”
            const cleanForm    = contenedor.querySelector('#formArchivosCobertura');
            const cleanBtnNext = contenedor.querySelector('#btnNextCobertura');
            const cleanBtnRec  = contenedor.querySelector('#rectificarCobertura');
      
            try {
              // 5) Comprueba si ya hay un PDF de cobertura en la BD
              const res = await fetch(`/archivos/${id}/archivos/cobertura`);
              if (!res.ok) throw new Error(`GET cobertura falló: ${res.status}`);
              const { pdf_cobertura } = await res.json();
      
              if (pdf_cobertura) {
                // Mostrar vista de descarga
                area.style.display   = 'none';
                vistas.style.display = 'block';
                linkP.href = `/descargas/${pdf_cobertura}`;
              } else {
                // Si no existe, sigue mostrando el formulario
                area.style.display   = 'block';
                vistas.style.display = 'none';
                if(USUARIO_ACTUAL != 'aseguradora'){
                    area.style.display = 'none';
                    cleanBtnNext.style.display = 'none';
                    cleanBtnRec.style.display = 'none';
                  };
              }
      
              // 6) Listener para subir un PDF de cobertura
              cleanForm.addEventListener('submit', async e => {
                e.preventDefault();
                try {
                  const data = new FormData(cleanForm);
                  const resp = await fetch(`/archivos/${id}/archivos/cobertura`, {
                    method: 'POST',
                    body: data
                  });
                  if (!resp.ok) throw new Error(`POST cobertura falló: ${resp.status}`);
                  // Si todo ok, recarga solo este paso
                  await initPaso3(id);
                  getEstado();
                } catch (err) {
                  console.error('Error en subida de cobertura:', err);
                  alert('Error subiendo PDF de cobertura. Comprueba la consola.');
                }
              });
      
              // 7) Botón “Reemplazar cobertura” vuelve a mostrar el formulario
              cleanBtnRec.addEventListener('click', () => {
                vistas.style.display = 'none';
                area.style.display   = 'block';
              });
      
              // 8) Botón “Siguiente paso” reutiliza tu función pasarStep()
              pasarStep(id, cleanBtnNext);
      
            } catch (err) {
              console.error('Error en initPaso3:', err);
              alert('No se pudieron cargar los archivos de cobertura. Mira la consola.');
            }
          }
        </script>
      </div>
      
      <div id="cuatro" class="bloques" hidden>
        <h1>Informe del peritaje:</h1>
  <div id="areaSubidaPeritaje">
    <form id="formArchivosPeritaje">
      <label>PDF de Peritaje:</label><br>
      <input type="file" name="pdf" accept="application/pdf" required><br>
      <button type="submit">Subir peritaje</button>
    </form>
    
  </div>
  <div id="vistasPeritaje" style="display:none;">
    <h3>PDF de Peritaje subido:</h3>
    <div><a id="linkPDFPeritaje" href="#" download>Descargar peritaje</a></div>
    
  </div>
  
  <!-- AQUI MOSTRAMOS el precio actual (si existe) -->
  <p>Precio publicado: <span id="precioActual">—</span> €</p>

  
  
  <div id="botonesCuatro">
    <input type="number" id="cantidadPeritaje" placeholder="Cantidad a pagar" required>
    <button id="btnPublicarPeritaje">Publicar cantidad</button>
  <button id="rectificarPeritaje">Reemplazar peritaje</button>
  <button id="btnNextPeritaje">Siguiente paso</button>
</div>
  

  <script>
   

    // ─── Inicializa el paso 3: obtiene y muestra precio_perit ───
    async function initPaso4_1(id) {
    const precioSpan = document.getElementById('precioActual');
    const inputCantidad = document.getElementById('cantidadPeritaje');
    const btnPublicar = document.getElementById('btnPublicarPeritaje');

    // 1) Primero, obtenemos el precio existente (GET) y lo mostramos
    try {
      const res = await fetch(`/mis-expedientes/${id}`);
      if (!res.ok) throw new Error(`GET expediente falló: ${res.status}`);
      const data = await res.json();
      if (data.precio_perito != null) {
        precioSpan.textContent = data.precio_perito;
      } else {
        precioSpan.textContent = '—';
      }
    } catch (err) {
      console.error('Error obteniendo precio_perito:', err);
      precioSpan.textContent = '—';
    }

    // 2) Ahora, registramos el listener de click sobre el botón
    //    (Primero, nos aseguramos de eliminar posibles listeners previos
    //     clonando el nodo y reasignándolo)
    const nuevoBtn = btnPublicar.cloneNode(true);
    btnPublicar.replaceWith(nuevoBtn);
    if(USUARIO_ACTUAL != 'perito'){
            nuevoBtn.style.display = 'none';
              inputCantidad.style.display = 'none';
            };
    nuevoBtn.addEventListener('click', async () => {
      const valor = parseFloat(inputCantidad.value);
      if (isNaN(valor)) {
        return alert('Introduce una cantidad válida.');
      }

      try {
        const respuesta = await fetch(`/mis-expedientes/${id}/precio-perito`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ precio_perito: valor })
        });
        if (!respuesta.ok) {
          const text = await respuesta.text();
          throw new Error(`Error ${respuesta.status}: ${text}`);
        }
        // Refrescamos el valor mostrado tras el POST
        await initPaso4_1(id);
        getEstado();
      } catch (err) {
        console.error('Error publicando precio_perito:', err);
        alert('No se pudo publicar la cantidad. Revisa la consola.');
      }
    });
  }
</script>

  <script>
    async function initPaso4(id) {
      // 1) Localiza solo el contenedor de cuatro
      const contenedor = document.getElementById('cuatro');
      if (!contenedor) return;

      // 2) Busca dentro de él los elementos con sus nuevos IDs
      const form    = contenedor.querySelector('#formArchivosPeritaje');
      const btnNext = contenedor.querySelector('#btnNextPeritaje');
      const btnRec  = contenedor.querySelector('#rectificarPeritaje');
      const area    = contenedor.querySelector('#areaSubidaPeritaje');
      const vistas  = contenedor.querySelector('#vistasPeritaje');
      const linkP   = contenedor.querySelector('#linkPDFPeritaje');

      // Comprueba que existan todas las referencias
      if (!form || !btnNext || !btnRec || !area || !vistas || !linkP) {
        console.error('initPaso4: algún ID falta dentro de #cuatro');
        return;
      }

      // 3) Remueve posibles listeners anteriores clonando nodos
      form.replaceWith(form.cloneNode(true));
      btnNext.replaceWith(btnNext.cloneNode(true));
      btnRec.replaceWith(btnRec.cloneNode(true));

      // 4) Vuelve a tomar las referencias “limpias”
      const cleanForm    = contenedor.querySelector('#formArchivosPeritaje');
      const cleanBtnNext = contenedor.querySelector('#btnNextPeritaje');
      const cleanBtnRec  = contenedor.querySelector('#rectificarPeritaje');

      try {
        // 5) Comprueba si ya hay un PDF de Peritaje en la BD
        const res = await fetch(`/archivos/${id}/archivos/peritaje`);
        if (!res.ok) throw new Error(`GET peritaje falló: ${res.status}`);
        const { pdf_peritaje } = await res.json();

        if (pdf_peritaje) {
          // Mostrar vista de descarga
          area.style.display   = 'none';
          vistas.style.display = 'block';
          linkP.href = `/descargas/${pdf_peritaje}`;
        } else {
          // Si no existe, sigue mostrando el formulario
          area.style.display   = 'block';
          vistas.style.display = 'none';
          if(USUARIO_ACTUAL != 'perito'){
                    area.style.display = 'none';
                    
                    cleanBtnRec.style.display = 'none';
                  };
          if(USUARIO_ACTUAL != 'aseguradora'){
                  cleanBtnNext.style.display = 'none';
          }
                  
          
        }

        // 6) Listener para subir un PDF de peritaje
        cleanForm.addEventListener('submit', async e => {
          e.preventDefault();
          try {
            const data = new FormData(cleanForm);
            const resp = await fetch(`/archivos/${id}/archivos/peritaje`, {
              method: 'POST',
              body: data
            });
            if (!resp.ok) throw new Error(`POST peritaje falló: ${resp.status}`);
            // Si todo ok, recarga solo este paso
            await initPaso4(id);
            getEstado();
          } catch (err) {
            console.error('Error en subida de peritaje:', err);
            alert('Error subiendo PDF de peritaje. Comprueba la consola.');
          }
        });

        // 7) Botón “Reemplazar peritaje“ vuelve a mostrar el formulario
        cleanBtnRec.addEventListener('click', () => {
          vistas.style.display = 'none';
          area.style.display   = 'block';
        });

        // 8) Botón “Siguiente paso” reutiliza tu función pasarStep()
        pasarStep(id, cleanBtnNext);

      } catch (err) {
        console.error('Error en initPaso4:', err);
        alert('No se pudieron cargar los archivos de peritaje. Mira la consola.');
      }
    }
  </script>
  
      </div>
      <div id="cinco" class="bloques" hidden>
        <h1>Resolución de la tramitación</h1>
         <h4>Proceso Finalizado con Éxito</h4>

    <p>Se han recogido todas las pruebas necesarias y se ha determinado al culpable, 
    fallando a favor de nuestro cliente. Tras el análisis de la documentación y 
    los informes periciales, se ha establecido que la cantidad a pagar es de 
    <span class="highlight" id='cantidadAPagar'></span>.</p>

    <p>Con esta resolución, el expediente ha quedado completamente cerrado y resuelto 
    con éxito. Agradecemos la confianza depositada en nuestros servicios.</p>

    <p class="contact">Si tienes cualquier duda o necesitas más información, por favor 
    contáctanos en: <a href='email' id="gmailCompañia" >Email</a>.</p>
       
      </div>
      <script>
      async function initPaso5(id) {
         let cantida = document.getElementById('cantidadAPagar');
        
        let email = document.getElementById('gmailCompañia');
        email.href = `${gmailCompañia}`;
        email.textContent = `${gmailCompañia}`;
        
         try {
      const res = await fetch(`/mis-expedientes/${id}`);
      if (!res.ok) throw new Error(`GET expediente falló: ${res.status}`);
      const data = await res.json();
      if (data.precio_perito != null) {
        cantida.textContent = cantidadAPagar;
      } else {
        cantida.textContent = 'por determinar';
      }
    } catch (err) {
      console.error('Error obteniendo precio_perito:', err);
      precioSpan.textContent = '—';
    }
        }
      </script>
    </div>
  
    <!-- Barra lateral derecha con círculos -->
    <div class="sidebar-right">
      <div class="step" class="activo" id="circuloUno"> Recepción de la declaración </div>
      <div class="step" id="circuloDos"> Aclaración de succesos</div>
      <div class="step" id="circuloTres"> Cobertura poliza</div>
      <div class="step" id="circuloCuatro"> Peritaje</div>
      <div class="step" id="circuloCinco"> Resolución de la tramitación</div>
    </div>

    <script>
      
    let idUsuario = null; // Variable global para el ID del usuario
      let NombreUsuario = null; // Variable para el nombre del usuario
      // Al cargar la página comprobamos la sesión
      fetch('/api/session')
        .then(r => r.json())
        .then(({ user }) => {
          if (!user) {
            // Sin sesión: muestra el formulario de consulta
            document.getElementById('consultor-container').style.display = 'block';
            USUARIO_ACTUAL = 'sin'; // Usuario sin sesión


          } else {
            // Con sesión: guarda en una variable global o actualiza el DOM

            idUsuario = user.id;
            gmailCompañia = user.gmail;
          }
        })
        .catch(err => {
          console.error('Error comprobando la sesión:', err);
          //window.location.href = '/login';
        });

        
      
     async function buscarUser() {
  // Espera hasta que idUsuario tenga un valor (máximo 1 segundo)
  let intentos = 0;
  while (idUsuario === null && intentos < 20) {
    await new Promise(resolve => setTimeout(resolve, 50)); // espera 50ms
    intentos++;
  }

  if (!idUsuario) {
    console.error('No se pudo obtener el idUsuario a tiempo.');
    
  }

  try {
    const res = await fetch(`/api/usuario/${idUsuario}/tipo`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    USUARIO_ACTUAL = data.tipo;
    return data.tipo;
  } catch (err) {
    console.error('Error obteniendo tipo de usuario:', err);
  }
}


      
      function crearAreasSeleccionables(id_estado,id_expediente){
      const steps = [
  document.getElementById('circuloUno'),
  document.getElementById('circuloDos'),
  document.getElementById('circuloTres'),
  document.getElementById('circuloCuatro'),
  document.getElementById('circuloCinco')
  
];
 const botones = [
  document.getElementById('botonesUno'),
  document.getElementById('botonesDos'),
  document.getElementById('botonesTres'),
  document.getElementById('botonesCuatro')
  
  
];
const id = id_estado - 1;

const botones_recortado = botones.slice(0, id);
console.log(id)
botones_recortado.forEach(element => {
    element.hidden = true;
  });
const steps_recortado = steps.slice(0, id_estado);
//Aqui hay una mejora por realizar QUE PARECE SOLUCIONADA
steps_recortado.forEach((step, index) => {
  step.addEventListener('click', () => {
   
    // Oculta todos los bloques
    const bloques = document.getElementsByClassName('bloques');
    for (let i = 0; i < bloques.length; i++) {
      bloques[i].hidden = true;
    }

    // Quita la clase active de todos los círculos
    const circulos = document.getElementsByClassName('step');
    for (let i = 0; i < circulos.length; i++) {
      circulos[i].classList.remove('active');
    }

    // Muestra el bloque correspondiente al índice
    const area = bloques[index];
    if (area) area.hidden = false;

    // Activa el círculo clicado
    step.classList.add('active');
  });
});
};
      
      </script>

      

<script>
  document.addEventListener('DOMContentLoaded', async () => {
  await buscarUser();

  console.log("Tipo de usuario:", USUARIO_ACTUAL);

  
    // Referencias clave
    const contenedor = document.querySelector('.expedientes-container');
    const info       = document.getElementById('info');
    const btnCrear   = document.getElementById('crear-expediente');
    const modal      = document.getElementById('creador-container');
    const formCrear  = document.getElementById('formCrear');
    const btnCancelar= document.getElementById('cancelarCrear');
 if (USUARIO_ACTUAL !== 'aseguradora') {
    document.getElementById('crear-expediente').style.display = 'none';
  }
    // Mostrar formulario de creación
    btnCrear.addEventListener('click', () => {
      modal.style.display = 'block';
    });
    // Cancelar creación
    btnCancelar.addEventListener('click', () => {
      modal.style.display = 'none';
      formCrear.reset();
    });
  
    // Enviar formulario de creación
    formCrear.addEventListener('submit', e => {
      e.preventDefault();
  
      // Asegúrate de que tus inputs tienen name="descripcion", "matricula", "dni_cliente"
      const body = {
        descripcion: formCrear.descripcion.value.trim(),
        matricula: formCrear.matricula.value.trim(),
        dni_cliente: formCrear.dni_cliente.value.trim(),
        id_perito: Number(formCrear.id_perito.value.trim())
      };
      console.log(body);
      fetch('/mis-expedientes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      .then(res => {
        if (!res.ok) throw new Error('Error al crear expediente');
        return res.json();
      })
      .then(nuevo => {
        // Cerrar modal y reset
        modal.style.display = 'none';
        formCrear.reset();
  
        // Añadir al listado y seleccionar
        const div = document.createElement('div');
        div.className = 'expediente';
        div.textContent = nuevo.id_expediente;
        div.addEventListener('click', () => seleccionarExpediente(nuevo, div));
        contenedor.prepend(div);
        seleccionarExpediente(nuevo, div);
      })
      .catch(err => {
        alert(err.message);
      });
    });
  
    // Cargar lista inicial de expedientes
    fetch('/mis-expedientes')
      .then(r => r.ok ? r.json() : Promise.reject('Error cargando'))
      .then(data => {
        data.forEach(exp => {
          const div = document.createElement('div');
          div.className = 'expediente';
          div.textContent = exp.id_expediente;
          div.addEventListener('click', () => seleccionarExpediente(exp, div));
          contenedor.appendChild(div);
        });
      })
      .catch(console.error);
  });
  
  // Función de selección (fuera del DOMContentLoaded para que sea global)
  function seleccionarExpediente(exp, div) {
    buscarUser();
  // Limpia clases
  document.querySelectorAll('.expediente').forEach(el => el.classList.remove('activo'));
  div.classList.add('activo');

  // Guarda cookie
  document.cookie = `id_expediente=${exp.id_expediente}; path=/; max-age=${60*60}`;

  // Rellena info usando la variable correcta: exp
  document.getElementById('info').innerHTML = `
    ID: ${exp.id_expediente}<br>
    Descripción: ${exp.descripcion}<br>
    Matrícula: ${exp.matricula}<br>
    DNI cliente: ${exp.dni_cliente}<br>
    Fecha creación: ${exp.fecha_creacion}
  `;
  // Muestra el paso 1 y llama a init, pasando exp.id_expediente
fetch('/estado-expediente')
  .then(res => {
    if (!res.ok) throw new Error('No hay estado');
    return res.json();
  })
  .then(estado => {

      
     crearAreasSeleccionables(estado.id_estado,exp.id_expediente);
      
  })
  .catch(err => console.error(err));

  
  initPaso1(exp.id_expediente);
  initPaso2(exp.id_expediente);
  initPaso3(exp.id_expediente);
  initPaso4(exp.id_expediente);
  initPaso4_1(exp.id_expediente);
  initPaso5(exp.id_expediente);
  getEstado();
};
 


  </script>
      
      
<script>
  document.getElementById('formConsulta').addEventListener('submit', e => {
    e.preventDefault();
    const errorDiv = document.getElementById('error');
    const info = document.getElementById('info');
    const contenedor = document.querySelector('.expedientes-container');
    errorDiv.textContent = '';
    info.textContent = '';
    const numExp = document.getElementById('numExpediente').value.trim();
    const dni    = document.getElementById('dni').value.trim();
    const mat    = document.getElementById('matricula').value.trim();

    fetch('/consulta-expediente', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        numExpediente: numExp,
        dni: dni,
        matricula: mat
      })
    })
    .then(res => {
      if (res.status === 404) {
        throw new Error('No se encontró expediente con esos datos');
      }
      if (!res.ok) {
        throw new Error('Error del servidor');
      }
      return res.json();
    })
    .then(exp => {
      // Pintar resultado
      document.cookie = `id_expediente=${exp.id_expediente}; path=/; max-age=${60*60}`;
      getEstado();
      const div = document.createElement('div');
        div.className = 'expediente';
        div.textContent = exp.id_expediente;
        div.addEventListener('click', () => seleccionarExpediente(exp, div));
        contenedor.prepend(div);
        seleccionarExpediente(exp, div);
      
      info.innerHTML = `
        <h3>Expediente #${exp.id_expediente}</h3>
        <p><strong>Descripción:</strong> ${exp.descripcion || '—'}</p>
        <p><strong>Matrícula:</strong> ${exp.matricula}</p>
        <p><strong>DNI Cliente:</strong> ${exp.dni_cliente}</p>
        <p><strong>Fecha Creación:</strong> ${exp.fecha_creacion}</p>
      `;
      document.getElementById('consultor-container').style.display = 'none';
      
      if(document.getElementById('nuevoExpediente')){
        let nuevo = document.getElementById('nuevo expediente');
        nuevo.remove();
        nuevaConsulta()
      }else{
        nuevaConsulta()
      }

      function nuevaConsulta() {
        const div = document.createElement('div');
        div.id = 'nuevoExpediente';
        div.className = 'expediente';
        div.textContent = "Consultar nuevo expediente";
        
        div.addEventListener('click', () => {
          document.getElementById('consultor-container').style.display = 'block';
          
        });
        document.querySelector('.expedientes-container').appendChild(div);
      }

    })
    .catch(err => {
      errorDiv.textContent = err.message;
    });
  });
</script>


    <script>
function getEstado() {
      fetch('/estado-expediente')
  .then(res => {
    if (!res.ok) throw new Error('No hay estado');
    return res.json();
  })
  .then(estado => {

      const bloques = document.getElementsByClassName('bloques');
      for (let i = 0; i < bloques.length; i++) {
              bloques[i].hidden = true;
            }
      const circulos = document.getElementsByClassName('step');
      for (let i = 0; i < circulos.length; i++) {
              circulos[i].classList.remove('active');
            }
      switch (estado.nombre_estado){
        case 'Recepción de la declaración':
          document.getElementById('uno').removeAttribute('hidden');
          document.getElementById('circuloUno').classList.add('active');
          
            
          break;
        case 'Aclaración de sucesos':
       
          document.getElementById('dos').removeAttribute('hidden');
          document.getElementById('circuloDos').classList.add('active');
            
          break;
        case 'Cobertura poliza':
       
          document.getElementById('tres').removeAttribute('hidden');
          document.getElementById('circuloTres').classList.add('active');
          
          break;
        case 'Peritaje':
       
          document.getElementById('cuatro').removeAttribute('hidden');
          document.getElementById('circuloCuatro').classList.add('active');
         
          break;
        case 'Resolución de la tramitación':
       
          document.getElementById('cinco').removeAttribute('hidden');
          document.getElementById('circuloCinco').classList.add('active');
         
          break;
      }
  })
  .catch(err => console.error(err));
};
    </script>

    

  




  <!-- Script corregido -->
  <script>
      fetch('./top.html')  // ¡Atención a la barra inicial!
          .then(response => {
              if (!response.ok) throw new Error('Network response was not ok');
              return response.text();
          })
          .then(html => {
              document.getElementById('header-container').innerHTML = html;
              // Ejecutar scripts del header si existen
              const headerScripts = document.getElementById('header-container').getElementsByTagName('script');
              Array.from(headerScripts).forEach(script => {
                  const newScript = document.createElement('script');
                  newScript.text = script.innerHTML;
                  document.body.appendChild(newScript).parentNode.removeChild(newScript);
              });
          })
          .catch(error => console.error('Error loading header:', error));
  </script>

  <script>
    function pasarStep(id, cleanBtnNext){
    cleanBtnNext.addEventListener('click', async () => {
          try {
            const resp = await fetch(`/expedientes/${id}/next`, {
              method: 'POST',
              credentials: 'same-origin'       // <— incluye la cookie de sesión
            });
            console.log('nextEstado response status:', resp.status);
            const text = await resp.text();
            console.log('nextEstado response body:', text);
            if (!resp.ok) {
              throw new Error(`Error ${resp.status}: ${text}`);
            }
            // Si todo OK, recarga
            window.location.reload();
          } catch (err) {
            console.error('Error cambiando estado:', err);
            alert(`No se pudo avanzar de estado:\n${err.message}`);
          }
        });
      }
  </script>
     <!-- Contenedor para el header -->

     <!-- Script corregido -->
     
     <script>
         fetch('./bottom.html')  // ¡Atención a la barra inicial!
             .then(response => {
                 if (!response.ok) throw new Error('Network response was not ok');
                 return response.text();
             })
             .then(html => {
                 document.getElementById('bottom-container').innerHTML = html;
                 // Ejecutar scripts del header si existen
                 const headerScripts = document.getElementById('bottom-container').getElementsByTagName('script');
                 Array.from(headerScripts).forEach(script => {
                     const newScript = document.createElement('script');
                     newScript.text = script.innerHTML;
                     document.body.appendChild(newScript).parentNode.removeChild(newScript);
                 });
             })
             .catch(error => console.error('Error loading bottom:', error));
     </script>
  <style>
 /* Variables globales */
:root {
  --color-primary: #005f99;
  --color-accent: #0175bd;
  --color-bg: #f7f9fc;
  --color-surface: #ffffff;
  --color-border: #e1e4e8;
  --color-text: #333333;
  --font-base: 'Segoe UI', Roboto, Ubuntu, sans-serif;
  --transition: 0.3s ease;
}

/* Reset y box-sizing */
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  font-family: var(--font-base);
  background-color: var(--color-bg);
  color: var(--color-text);
}

h1, h4{
  color: var(--color-primary);
}



/* Header y footer (si lo tienes) */
#header-container,
#bottom-container {
  height: 50px; /* ajusta según tu contenido */
}

/* Layout principal */
.app-body {
  display: grid;
  grid-template-columns: 200px 1fr 200px;
  height: calc(100% - 160px); /* header + footer */
  overflow: hidden;
}

/* Sidebar izquierdo: lista de expedientes */
.sidebar-left {
  background-color: var(--color-surface);
  border-right: 1px solid var(--color-border);
  padding: 1rem;
  overflow-y: auto;
}

.expedientes-container {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.expediente {
  background-color: var(--color-bg);
  padding: 0.75rem;
  border: 1px solid var(--color-border);
  border-radius: 0.5rem;
  text-align: center;
  cursor: pointer;
  transition: background-color var(--transition), transform var(--transition);
}

.expediente:hover {
  background-color: var(--color-primary);
  color: #fff;
  transform: translateY(-2px);
}

.expediente.activo {
  background-color: var(--color-accent);
  color: #fff;
  font-weight: bold;
}

/* Contenido principal */
.main-content {
  background-color: var(--color-surface);
  padding: 2rem;
  border-left: 1px solid var(--color-border);
  border-right: 1px solid var(--color-border);
  overflow-y: auto;
}

/* Sidebar derecho: pasos en círculos */
.sidebar-right {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: start;
  padding: 1rem;
  gap: 1rem;
  background-color: var(--color-surface);
}

.step {
  width: 70px;
  height: 70px;
  border: 2px solid var(--color-border);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 0.5rem;
  transition: background-color var(--transition), border-color var(--transition);
  font-size: 0.8rem;
}

.step.active {
  background-color: var(--color-accent);
  border-color: var(--color-accent);
  color: #fff;
}

/* Formularios modal (consultor) */
.consultor-container {
  position: fixed;
  top: 50%;
  left: 50%;
  width: 90%;
  max-width: 400px;
  background-color: var(--color-surface);
  padding: 2rem;
  border-radius: 0.75rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translate(-50%, -50%);
  z-index: 1000;
  display: none;
  text-align: left;
}

.consultor-container h2 {
  margin-bottom: 1.5rem;
  color: var(--color-primary);
  text-align: center;
}

.form-group {
  margin-bottom: 1rem;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

input[type="text"],
input[type="number"],
input[type="file"] {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--color-border);
  border-radius: 0.5rem;
  transition: border-color var(--transition);
}

input:focus {
  outline: none;
  border-color: var(--color-primary);
}

button {
  display: block;
  width: 100%;
  padding: 0.75rem;
  margin-top: 0.5rem;
  border: none;
  border-radius: 0.5rem;
  background-color: var(--color-primary);
  color: black;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color var(--transition);
}

button:hover {
  background-color: darken(var(--color-primary), 10%);
}

/* Link y párrafos */
p {
  margin-top: 1rem;
  line-height: 1.5;
}

a {
  color: var(--color-primary);
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* Bloques de estado: solo uno visible */
.bloques {
  animation: fadeIn var(--transition);
}

.bloques.active {
  display: block;
}

/* Animación suave */
@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

/* Responsive móvil */
@media (max-width: 768px) {
  .app-body {
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr auto;
  }
  .sidebar-left,
  .sidebar-right {
    display: none;
  }
  .main-content {
    border: none;
    padding: 1rem;
  }
}

</style>

</body>
</html>